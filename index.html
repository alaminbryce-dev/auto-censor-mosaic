<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bryce Censor â€” â™¡ Mosaic Autoâ€‘Censor</title>
  <style>
    :root { 
      --bg:#0a0b10; 
      --bg2:#0d0f17; 
      --panel:#121420; 
      --ink:#f8fafc; 
      --muted:#cbd5e1; 
      --accent:#ff6ad5; /* pink */
      --accent-2:#9b8cff; /* lilac */
      --accent-3:#5eead4; /* mint */
      --ring:#ffe0f5; 
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, rgba(255,106,213,.25), transparent 60%), radial-gradient(900px 500px at 110% 20%, rgba(155,140,255,.25), transparent 60%), linear-gradient(180deg,var(--bg),var(--bg2)); color:var(--ink);font:14px/1.6 'Inter', system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .sparkle{position:fixed; inset:0; pointer-events:none; background:radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.25), transparent 60%),radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,.2), transparent 60%), radial-gradient(1.5px 1.5px at 30% 80%, rgba(255,255,255,.18), transparent 60%);} 
    header{position:sticky;top:0;background:rgba(10,12,18,.55);backdrop-filter:blur(12px);border-bottom:1px solid #2a2f3d;z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:4px 0 0;font-weight:900;letter-spacing:.2px;font-family:'Nunito', system-ui; font-size: clamp(20px, 3vw, 28px);}
    h1 span{color:var(--accent); background:linear-gradient(90deg,var(--accent), var(--accent-2), var(--accent-3)); -webkit-background-clip:text; background-clip:text; color:transparent;}
    p.sub{margin:.25rem 0 0;color:var(--muted); display:flex; align-items:center; gap:8px}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid #2a2f3d;border-radius:20px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .card h2{margin:.2rem 0 .6rem;font-size:15px;letter-spacing:.3px;color:#cfd8e3}
    .controls .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin:10px 0}
    .controls label{color:#c7cbd4;font-size:13px}
    input[type="file"]{width:100%;}
    input[type="range"]{width:100%}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,var(--accent), var(--accent-2));color:white;border:none;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(255,106,213,.35);transition:transform .08s ease, box-shadow .2s ease}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#23283a; box-shadow:none}
    .btn .emoji{filter: drop-shadow(0 2px 6px rgba(255,255,255,.15));}
    .btn.secondary{background:#2a2f39}
    .row.inline{display:flex;gap:8px;flex-wrap:wrap}
    .canvasWrap{position:relative;display:grid;gap:8px}
    canvas, video, img{max-width:100%;border-radius:12px;background:#0a0c10}
    .meta{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:12px}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#1b1f27;border:1px solid #2c3140;border-radius:999px;padding:6px 10px}
    .hint{color:#9aa4b2;font-size:12px;margin-top:8px}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:var(--accent)}
    footer{padding:24px;color:#94a3b8;text-align:center}
    .pill{display:inline-block;font-size:11px;border:1px solid #2c3140;border-radius:999px;padding:2px 8px;margin-left:6px;color:#a5adba}
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div>
          <h1>Bryce Censor <span>â™¡ Mosaic</span></h1>
          <p class="sub">Cute, private autoâ€‘censor for images & videos â€” runs fully on your device <span>âœ¨</span></p>
        </div>
        <a class="btn" href="https://patreon.com/AlaminBryce" target="_blank" rel="noopener">
          <span class="emoji">ðŸ’–</span> Support on Patreon
        </a>
      </div>
    </div>
  </header>

  <div class="sparkle" aria-hidden="true"></div>
  <main class="wrap">
    <section class="card controls">
      <h2>1) Input</h2>
      <div class="row">
        <label for="file">Choose image or video</label>
        <span class="pill" id="fileMeta">No file</span>
      </div>
      <input id="file" type="file" accept="image/*,video/*" />

      <h2 style="margin-top:14px">2) Detection & Mosaic</h2>
      <div class="row"><label>Mosaic block size (px)</label><input id="blockSize" type="range" min="4" max="64" step="2" value="24"></div>
      <div class="row"><label>Coverage scale (%) <span class="pill" id="coverageVal">130%</span></label><input id="coverage" type="range" min="80" max="220" step="5" value="130"></div>
      <div class="row"><label>Confidence threshold <span class="pill" id="confVal">0.4</span></label><input id="confidence" type="range" min="0.2" max="0.8" step="0.05" value="0.4"></div>

      <div class="row inline" style="margin-top:12px">
        <label class="switch"><input id="live" type="checkbox" checked> Live for video</label>
        <label class="switch"><input id="showBox" type="checkbox"> Show censor box</label>
        <label class="switch"><input id="faceOn" type="checkbox"> Also mosaic faces</label>
      </div>

      <h2 style="margin-top:16px">3) Manual fixes (optional)</h2>
      <div class="row inline">
        <button class="btn secondary" id="brushBtn">Brush: OFF</button>
        <button class="btn secondary" id="undoBtn">Undo</button>
        <button class="btn secondary" id="clearBtn">Clear marks</button>
      </div>
      <p class="hint">If auto detection misses, toggle <b>Brush</b> then paint areas to mosaic. Undo/clear as needed.</p>

      <h2 style="margin-top:16px">4) Export</h2>
      <div class="row inline">
        <button class="btn" id="downloadBtn">Download result</button>
        <a id="reset" class="btn secondary" href="#">Reset</a>
      </div>

      <div class="meta" style="margin-top:12px">
        <span class="badge">Model: MoveNet Multiâ€‘Pose</span>
        <span class="badge" id="perf">â€“</span>
      </div>
      <p class="hint">Ethics: Donâ€™t process content involving minors. This tool runs entirely in your browser.</p>
    </section>

    <section class="card">
      <h2>Preview <span style="font-size:12px; opacity:.8">(nothing uploads â€” promise)</span></h2>
      <div class="canvasWrap">
        <canvas id="out"></canvas>
        <video id="vid" muted playsinline style="display:none"></video>
        <img id="img" alt="" style="display:none" />
      </div>
    </section>
  </main>

  <footer>
    <div style="display:flex; flex-direction:column; gap:8px; align-items:center;">
      <div>Built with <b>MoveNet</b> & clientâ€‘side canvas. <span aria-hidden="true">ðŸŒ¸</span></div>
      <div style="font-size:12px; opacity:.8">Ethics: never use with minors. Be kind & stay safe.</div>
    </div>
  </footer>

  <!-- TensorFlow / PoseDetection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.18.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.18.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@3.5.0/dist/pose-detection.min.js"></script>

  <script>
  const els = {
    file: document.getElementById('file'),
    fileMeta: document.getElementById('fileMeta'),
    canvas: document.getElementById('out'),
    img: document.getElementById('img'),
    vid: document.getElementById('vid'),
    blockSize: document.getElementById('blockSize'),
    coverage: document.getElementById('coverage'),
    coverageVal: document.getElementById('coverageVal'),
    conf: document.getElementById('confidence'),
    confVal: document.getElementById('confVal'),
    showBox: document.getElementById('showBox'),
    live: document.getElementById('live'),
    faceOn: document.getElementById('faceOn'),
    brushBtn: document.getElementById('brushBtn'),
    undoBtn: document.getElementById('undoBtn'),
    clearBtn: document.getElementById('clearBtn'),
    reset: document.getElementById('reset'),
    download: document.getElementById('downloadBtn'),
    perf: document.getElementById('perf')
  };

  let detector, animId, ctx, brushOn=false, brushStrokes=[];
  const offSmall = document.createElement('canvas');
  const offCtx = offSmall.getContext('2d');

  function setCanvasSize(w,h){ els.canvas.width=w; els.canvas.height=h; ctx = els.canvas.getContext('2d'); ctx.imageSmoothingEnabled=false; }
  function midpoint(a,b){ return {x:(a.x+b.x)/2,y:(a.y+b.y)/2}; }
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi,v)); }

  async function loadModel(){
    await tf.setBackend('webgl');
    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.MoveNet,
      { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING }
    );
  }

  function fileChosen(file){
    els.fileMeta.textContent = `${file.name} â€¢ ${(file.size/1024/1024).toFixed(2)} MB`;
    const url = URL.createObjectURL(file);
    stopLoop();
    brushStrokes.length = 0;
    if(file.type.startsWith('image/')){
      els.img.src = url; els.img.style.display=''; els.vid.style.display='none';
      els.img.onload = ()=>{ setCanvasSize(els.img.naturalWidth, els.img.naturalHeight); drawFrame(); };
    }else if(file.type.startsWith('video/')){
      els.vid.src = url; els.vid.style.display=''; els.img.style.display='none';
      els.vid.onloadedmetadata = ()=>{ setCanvasSize(els.vid.videoWidth, els.vid.videoHeight); els.vid.play(); if(els.live.checked) loop(); else drawFrame(); };
    }
  }

  async function estimatePoses(source){
    if(!detector) return [];
    const ts = performance.now();
    const poses = await detector.estimatePoses(source, {maxPoses:6, flipHorizontal:false});
    const dt = performance.now() - ts; els.perf.textContent = `Detection: ${dt.toFixed(1)} ms`;
    return poses || [];
  }

  // Heuristic genital box from pose: use hips & knees
  function genitalBoxFromKeypoints(kp, scale=1.3){
    const byName = {};
    for(const k of kp){ if(k.score==null) continue; byName[k.name||k.part||k.key||k.index] = k; }
    const lHip = kp.find(k=>k.name==='left_hip') || kp[23];
    const rHip = kp.find(k=>k.name==='right_hip') || kp[24];
    const lKnee = kp.find(k=>k.name==='left_knee') || kp[25];
    const rKnee = kp.find(k=>k.name==='right_knee') || kp[26];
    if(!lHip || !rHip || !lKnee || !rKnee) return null;
    if(lHip.score<Number(els.conf.value) || rHip.score<Number(els.conf.value)) return null;
    const hipsMid = midpoint(lHip, rHip);
    const hipWidth = dist(lHip, rHip);
    // Height towards knees (use closer knee vertically)
    const kneeY = Math.min(lKnee?.y||hipsMid.y+hipWidth, rKnee?.y||hipsMid.y+hipWidth);
    let h = clamp((kneeY - hipsMid.y) * 0.9, hipWidth*0.7, hipWidth*1.6);
    let w = clamp(hipWidth * 1.2, 40, hipWidth*2.2);
    w *= (scale/1.0); h *= (scale/1.0);
    const x = hipsMid.x - w/2;
    const y = hipsMid.y - h*0.15; // bias upward slightly from hips midpoint
    return {x,y,w,h};
  }

  // Optional quick face region (eyes/nose)
  function faceBoxFromKeypoints(kp){
    const nose = kp.find(k=>k.name==='nose');
    const lEye = kp.find(k=>k.name==='left_eye');
    const rEye = kp.find(k=>k.name==='right_eye');
    if(!(nose&&lEye&&rEye)) return null;
    if(nose.score<Number(els.conf.value)) return null;
    const eyeMid = midpoint(lEye, rEye);
    const eyeDist = dist(lEye, rEye);
    const size = eyeDist * 3.2;
    return {x:eyeMid.x - size/2, y:eyeMid.y - size/2, w:size, h:size*1.2};
  }

  function mosaicRegion(rect){
    const {x,y,w,h} = rect;
    const bx = Math.max(0, Math.floor(x));
    const by = Math.max(0, Math.floor(y));
    const bw = Math.min(els.canvas.width - bx, Math.floor(w));
    const bh = Math.min(els.canvas.height - by, Math.floor(h));
    if(bw<=0 || bh<=0) return;

    const block = Number(els.blockSize.value);
    const sx = Math.max(1, Math.floor(bw / block));
    const sy = Math.max(1, Math.floor(bh / block));

    offSmall.width = sx; offSmall.height = sy;
    // Copy region scaled down
    offCtx.imageSmoothingEnabled = true;
    offCtx.drawImage(els.canvas, bx, by, bw, bh, 0, 0, sx, sy);
    // Draw back scaled up (no smoothing for pixelation)
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(offSmall, 0, 0, sx, sy, bx, by, bw, bh);
  }

  function drawBoxes(rects, color='rgba(124,92,255,.35)'){
    if(!els.showBox.checked) return;
    ctx.save(); ctx.strokeStyle = 'rgba(124,92,255,.9)'; ctx.lineWidth=2; ctx.fillStyle=color;
    for(const r of rects){ ctx.fillRect(r.x,r.y,r.w,r.h); ctx.strokeRect(r.x,r.y,r.w,r.h); }
    ctx.restore();
  }

  async function drawFrame(){
    const source = els.vid.style.display!=="none" ? els.vid : els.img;
    if(!source) return;
    ctx.drawImage(source, 0, 0, els.canvas.width, els.canvas.height);

    const poses = await estimatePoses(source);
    const rects = [];
    for(const p of poses){
      const kp = (p.keypoints || []).map(k=>({x:k.x,y:k.y,score:k.score,name:k.name}));
      const g = genitalBoxFromKeypoints(kp, Number(els.coverage.value)/100);
      if(g) { mosaicRegion(g); rects.push(g); }
      if(els.faceOn.checked){ const f = faceBoxFromKeypoints(kp); if(f){ mosaicRegion(f); rects.push(f); } }
    }

    // Manual strokes
    for(const s of brushStrokes){ mosaicRegion(s); }
    drawBoxes(rects.concat(brushStrokes));
  }

  function loop(){
    cancelAnimationFrame(animId);
    const step = async ()=>{ await drawFrame(); animId = requestAnimationFrame(step); };
    animId = requestAnimationFrame(step);
  }

  function stopLoop(){ cancelAnimationFrame(animId); }

  // Brush painting
  let dragging=false, startPt=null;
  els.canvas.addEventListener('pointerdown', e=>{
    if(!brushOn) return; dragging=true; const r=els.canvas.getBoundingClientRect(); startPt={x:(e.clientX-r.left)*els.canvas.width/r.width, y:(e.clientY-r.top)*els.canvas.height/r.height};
  });
  els.canvas.addEventListener('pointermove', e=>{
    if(!brushOn || !dragging) return; drawFrame().then(()=>{
      const r=els.canvas.getBoundingClientRect();
      const cur={x:(e.clientX-r.left)*els.canvas.width/r.width, y:(e.clientY-r.top)*els.canvas.height/r.height};
      const rect={x:Math.min(startPt.x,cur.x), y:Math.min(startPt.y,cur.y), w:Math.abs(cur.x-startPt.x), h:Math.abs(cur.y-startPt.y)};
      drawBoxes([rect],'rgba(20,180,120,.28)');
    });
  });
  els.canvas.addEventListener('pointerup', e=>{
    if(!brushOn||!dragging) return; dragging=false; const r=els.canvas.getBoundingClientRect(); const end={x:(e.clientX-r.left)*els.canvas.width/r.width, y:(e.clientY-r.top)*els.canvas.height/r.height};
    const rect={x:Math.min(startPt.x,end.x), y:Math.min(startPt.y,end.y), w:Math.abs(end.x-startPt.x), h:Math.abs(end.y-startPt.y)}; brushStrokes.push(rect); drawFrame();
  });

  // UI wiring
  els.file.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) fileChosen(f); });
  els.blockSize.addEventListener('input', ()=>{ if(els.vid.style.display==='none') drawFrame(); });
  els.coverage.addEventListener('input', ()=>{ els.coverageVal.textContent=els.coverage.value+"%"; if(els.vid.style.display==='none') drawFrame(); });
  els.conf.addEventListener('input', ()=>{ els.confVal.textContent=Number(els.conf.value).toFixed(2); if(els.vid.style.display==='none') drawFrame(); });
  els.showBox.addEventListener('change', ()=>{ if(els.vid.style.display==='none') drawFrame(); });
  els.faceOn.addEventListener('change', ()=>{ if(els.vid.style.display==='none') drawFrame(); });
  els.live.addEventListener('change', ()=>{ if(els.vid.style.display!=='none'){ if(els.live.checked){ loop(); } else { stopLoop(); drawFrame(); } } });
  els.brushBtn.addEventListener('click', ()=>{ brushOn=!brushOn; els.brushBtn.textContent = `Brush: ${brushOn? 'ON' : 'OFF'}`; });
  els.undoBtn.addEventListener('click', ()=>{ brushStrokes.pop(); drawFrame(); });
  els.clearBtn.addEventListener('click', ()=>{ brushStrokes.length=0; drawFrame(); });
  els.reset.addEventListener('click', (e)=>{ e.preventDefault(); stopLoop(); els.img.src=''; els.vid.src=''; els.img.style.display='none'; els.vid.style.display='none'; ctx?.clearRect(0,0,els.canvas.width,els.canvas.height); els.file.value=''; els.fileMeta.textContent='No file'; brushStrokes.length=0; });
  els.download.addEventListener('click', ()=>{ const a=document.createElement('a'); a.download = 'censored.png'; a.href = els.canvas.toDataURL('image/png'); a.click(); });

  // Bootstrap
  loadModel();
  </script>
</body>
</html>
